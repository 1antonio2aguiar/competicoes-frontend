# ==========================
# üèóÔ∏è Etapa 1 ‚Äî Build do Angular
# ==========================
FROM node:18-alpine AS build
WORKDIR /app

# Copia apenas os arquivos de depend√™ncias primeiro (melhor aproveitamento de cache)
COPY package*.json ./

# Instala depend√™ncias (com cache)
#RUN npm ci --force
RUN npm install --legacy-peer-deps

# Copia o restante do projeto
COPY . .

# üîß Garante que a pasta dist exista (corrige o erro do COPY no est√°gio seguinte)
RUN mkdir -p /app/dist

# Compila o Angular em modo produ√ß√£o
RUN npm run build -- --configuration=production

# ==========================
# üöÄ Etapa 2 ‚Äî Servidor Nginx
# ==========================
FROM nginx:stable-alpine

# Copia os artefatos do build Angular para o diret√≥rio padr√£o do Nginx
COPY --from=build /app/dist/competicoes-ui /usr/share/nginx/html

# Copia a configura√ß√£o customizada (ajustando portas e backend)
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Define a porta esperada pelo Cloud Run
ENV PORT=8080
EXPOSE 8080

# Comando padr√£o do Nginx
CMD ["nginx", "-g", "daemon off;"]


##*********************************************************************************

# ==========================
# üèóÔ∏è Etapa 1 ‚Äî Build do Angular
# ==========================
FROM node:18-alpine AS build
WORKDIR /app

# Copia apenas os arquivos de depend√™ncias primeiro (melhor aproveitamento de cache)
COPY package*.json ./

# Instala depend√™ncias (com cache)
#RUN npm ci --force
RUN npm install --legacy-peer-deps

# Copia o restante do projeto
COPY . .

# === NOVOS PASSOS PARA GARANTIR O AMBIENTE DE PRODU√á√ÉO ===
# Opcional, mas pode ajudar a garantir que o cache de npm n√£o esteja causando problemas
RUN npm cache clean --force

# Cria o arquivo de ambiente de produ√ß√£o temporariamente
# Garante que o Angular use este ambiente com o '/'
# IMPORTANTE: Substitua o conte√∫do pela sua configura√ß√£o EXATA de environment.prd.ts
RUN echo "export const environment = { production: true, version: '1.0.0', apiUrl: '/', pessoasApiUrl: '/', sistemaId: 'competicoes-ui' };" > src/environments/environment.ts
# (Este passo sobrescreve o environment.ts de desenvolvimento com o de produ√ß√£o antes da build)
# ou, uma forma mais limpa √© garantir que o Angular CLI use o --prod
# ou, ainda melhor, copiar o .prd.ts para .ts

# Melhor abordagem: Copiar o ambiente de produ√ß√£o para o padr√£o antes da build
RUN cp src/environments/environment.prod.ts src/environments/environment.ts
# =========================================================

#C:\projetos\competicoes\competicoes-ui\src\environments

# üîß Garante que a pasta dist exista (corrige o erro do COPY no est√°gio seguinte)
RUN mkdir -p /app/dist

# Compila o Angular em modo produ√ß√£o
RUN npm run build -- --configuration=production
# ^^^ Este comando j√° deve usar environment.prd.ts, mas o cp acima garante.
# Outra alternativa seria usar npm run build --prod ou ng build --prod, dependendo do package.json

# ... restante do Dockerfile